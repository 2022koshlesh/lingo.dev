name: Claude Issue Autolabeling

on:
  issues:
    types: [opened]

jobs:
  autolabel:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Repository Labels
        id: labels
        run: |
          labels=$(gh label list --limit 100 --json name,description --jq 'map("\(.name) (\(.description))") | join(", ")')
          echo "available_labels=$labels" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Autolabel Issue
        id: claude_analysis
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_ANTHROPIC_API_KEY }}
          timeout_minutes: "5"
          allowed_tools: "Bash"
          direct_prompt: |
            Analyze this newly created issue and apply appropriate labels using the gh CLI.

            Available repository labels: ${{ steps.labels.outputs.available_labels }}

            Tasks:
            1. Analyze the issue content
            2. Use `gh issue edit ${{ github.event.issue.number }} --add-label "label-name"` to apply each relevant label
            3. Add a comment explaining your labeling decisions

            Requirements:
            - Apply ALL relevant labels that match the issue content
            - If no labels are truly relevant, apply NO labels at all
            - Be thorough but precise - don't force labels that don't fit
            - Use the Bash tool to run gh commands WITHOUT asking for confirmation
            - The GITHUB_TOKEN is already set in the environment for gh authentication

            Issue Title: ${{ github.event.issue.title }}
            Issue Body: ${{ github.event.issue.body }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

